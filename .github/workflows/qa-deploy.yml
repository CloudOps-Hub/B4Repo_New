name: Salesforce QA Deployment

on:
  push:
    branches: 
      - develop
    paths: 
      - "force-app/**"
jobs:
    deploy:
        runs-on: ubuntu-latest
    
        steps:
          - name: Checkout Repository
            uses: actions/checkout@v6.0.2
            with:
              fetch-depth: 0
              
          - name: Setup Node.js environment
            uses: actions/setup-node@v6.2.0

          - name: Install SF CLI
            run: npm install --global @salesforce/cli

          - name: Install sfdx-git-delta Plugin
            run: echo "y" | sf plugins install sfdx-git-delta

          - name: Generate the package.xml for delta files
            run: |
              mkdir delta
              sf sgd source delta --to "HEAD" --from "HEAD~1" \
                --output-dir "./delta" --ignore-whitespace -d
              echo "--- package.xml generated with added and modified metadata ---"
              ls -R delta
              cat delta/package/package.xml || echo "No package.xml generated"

          - name: Run SFDX CLI Scanner
            run: |
                mkdir reports
                sf code-analyzer run \
                  -t "force-app" \
                  --rule-selector pmd --rule-selector eslint --rule-selector cpd \
                  --output-file reports/scan-reports.html
        
          - name: Upload CLI Scanner HTML report
            uses: actions/upload-artifact@v4
            with:
              name: cli-scan-report
              path: reports/scan-reports.html

          - name: Authenticate SF 
            run: |
                echo "${{secrets.JWT_KEY}}" > server.key
                  
                sf org login jwt --client-id ${{ secrets.CLIENT_ID }} --jwt-key-file server.key --username ${{ secrets.SF_USERNAME_QA }} --instance-url ${{ secrets.SandboxURL }} --alias B3QA
            
                - name: SF Validate Changes
                run: |
                    sf project deploy start \
                      --manifest delta/package/package.xml \
                      --post-destructive-changes delta/destructiveChanges/destructiveChanges.xml \
                      --target-org B3QA --wait 120 --verbose 
